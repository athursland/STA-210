---
title: "Final Project"
author: "Ali Thursland and Mary Helen Wood"
date: "11/20/2018"
output: html_document
---

```{r setup, warning=FALSE, echo=FALSE, message=FALSE}
#Setup
library("dplyr")
library("ggplot2")
library("broom")
library("knitr")
library("cowplot")
library("readr")
library("dslabs")
library("varhandle")
library("olsrr")
library("car")
```

```{r data}
#Read file
airbnb <- read.csv("https://raw.githubusercontent.com/athursland/STA-210/master/airbnb.csv?fbclid=IwAR0ffZSvoMPWxJjX-a4gWp2UlripEqAK0NJtu2ioHgmG0uWjCm20Hse8pNw")

glimpse(airbnb)
```

# Data Preparation

```{r manipulating-data}
#Make new variable has_reviews
airbnb <- airbnb %>% 
  mutate(has_reviews = case_when( 
    number_of_reviews == 0 ~ 0, 
    number_of_reviews > 0 ~ 1)
  )

#Make NAs = 0 for security_deposit
airbnb <- airbnb %>% 
  mutate(security_deposit = if_else(is.na(security_deposit),0,security_deposit))

#Make NAs = 0 for cleaning_fee
airbnb <- airbnb %>% 
  mutate(cleaning_fee = if_else(is.na(cleaning_fee),0,cleaning_fee))

#Make NAs = 0 for review_scores_rating
airbnb <- airbnb %>% 
  mutate(review_scores_rating = case_when(
    is.na(review_scores_rating) ~ 0, 
    !is.na(review_scores_rating) ~ review_scores_rating)
    )

#Make NAs = 0 for review_scores_accuracy
airbnb <- airbnb %>% 
  mutate(review_scores_accuracy = case_when(
    is.na(review_scores_accuracy) ~ 0, 
    !is.na(review_scores_accuracy) ~ review_scores_accuracy)
    )

#Make NAs = 0 for review_scores_cleanliness
airbnb <- airbnb %>% 
  mutate(review_scores_cleanliness = case_when( 
    is.na(review_scores_cleanliness) ~ 0, 
    !is.na(review_scores_cleanliness) ~ review_scores_cleanliness)
    )

#Make NAs = 0 for review_scores_checkin
airbnb <- airbnb %>% 
  mutate(review_scores_checkin = case_when( 
    is.na(review_scores_checkin) ~ 0, 
    !is.na(review_scores_checkin) ~ review_scores_checkin)
    )

#Make NAs = 0 for review_scores_communcation
airbnb <- airbnb %>% 
  mutate(review_scores_communication = case_when( 
    is.na(review_scores_communication) ~ 0, 
    !is.na(review_scores_communication) ~ review_scores_communication)
    )

#Make NAs = 0 for review_sores_location 
airbnb <- airbnb %>% 
  mutate(review_scores_location = case_when( 
    is.na(review_scores_location) ~ 0, 
    !is.na(review_scores_location) ~ review_scores_location)
    )

#Make NAs = 0 for review_scores_value
airbnb <- airbnb %>% 
  mutate(review_scores_value = case_when( 
    is.na(review_scores_value) ~ 0, 
    !is.na(review_scores_value) ~ review_scores_value)
    )

#Make NAs = 0 for reviews_per_month
airbnb <- airbnb %>% 
  mutate(reviews_per_month = case_when( 
    is.na(reviews_per_month) ~ 0, 
    !is.na(reviews_per_month) ~ reviews_per_month)
    )
```

```{r transform-reviews}
#Log transform reviews_per_month
airbnb <- airbnb %>% 
  mutate(reviews_per_month.1 = reviews_per_month + 1,
  log.reviews_per_month = log(reviews_per_month.1))

#Log transform review_scores_rating
airbnb <- airbnb %>% 
  mutate(review_scores_rating.1 = review_scores_rating + 1,
  log.review_scores_rating = log(review_scores_rating.1))

#Log transform reviews_scores_value
airbnb <- airbnb %>% 
  mutate(review_score_value.1 = review_scores_value + 1,
  log.review_scores_value = log(review_score_value.1))

#Log transform review_scores_location
airbnb <- airbnb %>% 
  mutate(review_scores_location.1 = review_scores_location + 1,
  log.review_scores_location = log(review_scores_location.1))

#Log transform review_scores_communication
airbnb <- airbnb %>% 
  mutate(review_scores_communication.1 = review_scores_communication + 1,
  log.review_scores_communication = log(review_scores_communication.1))

#Log transform review_scores_checkin
airbnb <- airbnb %>% 
  mutate(review_scores_checkin.1 = review_scores_checkin + 1,
  log.review_scores_checkin = log(review_scores_checkin.1))

#Log transform review_scores_accuracy
airbnb <- airbnb %>% 
  mutate(review_scores_accuracy.1 = review_scores_accuracy + 1,
  log.review_scores_accuracy = log(review_scores_accuracy.1))

#Log transform review_scores_cleanliness
airbnb <- airbnb %>% 
  mutate(review_scores_cleanliness.1 = review_scores_cleanliness + 1,
  log.review_scores_cleanliness = log(review_scores_cleanliness.1))

#log transform number_of_reviews
airbnb <- airbnb %>% 
  mutate(number_of_reviews.1 = number_of_reviews + 1,
  log.number_of_reviews = log(number_of_reviews.1))

#Make NAs = 0 for host_response_rate
#airbnb <- airbnb %>% 
  #mutate(host_response_rate = case_when( 
    #is.na(host_response_rate) ~ 0.0, 
    #!is.na(host_response_rate) ~ host_response_rate)
    #)
```

```{r price-factor, message=FALSE}
#Make price as numeric
airbnb$price <- as.numeric(as.character(airbnb$price))
```


#Make host_response_rate as numeric
#airbnb$host_response_rate <- as.character(sub("%", "", airbnb$host_response_rate))
#airbnb$host_response_rate <- as.numeric(airbnb$host_response_rate)
#airbnb$host_response_rate


```{r zipcode}
#Make zipcode a factor
airbnb$zipcode <- as.factor(airbnb$zipcode)

# Make zipcode indicator for 28801
#airbnb <- airbnb %>% mutate(inzip28801 = 
                              #ifelse(zipcode == 28801, "yes", "no"))

airbnb <- airbnb %>% 
  mutate(inzip28801 = case_when( 
    zipcode == 28801 ~ "yes",
    zipcode == 28704 ~ "no",
    zipcode == 28715 ~ "no",
    zipcode == 28732 ~ "no", 
    zipcode == 28748 ~ "no",
    zipcode == 28787 ~ "no",
    zipcode == 28803 ~ "no",
    zipcode == 28804 ~ "no",
    zipcode == 28805 ~ "no",
    zipcode == 28806 ~ "no",
    zipcode == 28815 ~ "no",
    zipcode == 29710 ~ "no")
    )

airbnb <- airbnb %>% 
  mutate(inzip28804 = case_when( 
    zipcode == 28801 ~ "no",
    zipcode == 28704 ~ "no",
    zipcode == 28715 ~ "no",
    zipcode == 28732 ~ "no", 
    zipcode == 28748 ~ "no",
    zipcode == 28787 ~ "no",
    zipcode == 28803 ~ "no",
    zipcode == 28804 ~ "yes",
    zipcode == 28805 ~ "no",
    zipcode == 28806 ~ "no",
    zipcode == 28815 ~ "no",
    zipcode == 29710 ~ "no")
    )

# Make zipcode indicator for 28804
#airbnb <- airbnb %>% mutate(inzip28804 = ifelse(zipcode == 28804, "yes","no"))

glimpse(airbnb)
airbnb$inzip28801 <- as.factor(airbnb$inzip28801)
airbnb$inzip28804 <- as.factor(airbnb$inzip28804)

# Reference Levels
airbnb$inzip28801 <- relevel(airbnb$inzip28801, ref="no")
airbnb$inzip28804<- relevel(airbnb$inzip28804, ref="no")
```

```{r omit-na}
#Omit all observations with NAs 
airbnb <- airbnb[complete.cases(airbnb),]
```

```{r, transform - logprice}
airbnb <- airbnb %>% mutate(logprice = log(price))
```


# Separate training and testing
```{r separate}
#80% of the sample size
smp_size <- floor(0.80 * nrow(airbnb))

#set the seed to make your partition reproducible
set.seed(123456)
train_ind <- sample(seq_len(nrow(airbnb)), size = smp_size)

train.airbnb <- airbnb[train_ind, ]
test.airbnb <- airbnb[-train_ind, ]
```


# Description of data

Question of interest: How can we produce a model that accurately predicts the listed nightly price for an Airbnb in Asheville, NC?

  The data set we are using is a .csv file of every AirBnB listing in the city of Asheville, North Carolina as of October 17, 2018 . Each observation is an individual listing. We sourced this data from Inside AirBnB, a website that regularly scrapes data from AirBnB’s listings and provides them as public data sets separated by city.

  The original data set was very large (96 columns and 1,936 observations), so we reduced it for simplicity’s sake. We chose 26 columns that could potentially be of interest for a regression analysis, and we created one more column called has_reviews, which is an indicator variable. We noticed that some columns, like cleaning_fee and security_deposit, had a lot of NAs, so instead of omitting all of these observations we mutated NAs from these columns to be 0s. We were left with 24 incomplete cases, likely the result of web scraping errors, and so we chose to omit them. Our final number of columns was 27 and our final number of rows was 1,900. 

Variables: 
* host_response_rate
* host_is_superhost
* host_listings_count
* zipcode
* property_type
* room_type
* accomodates
* bathrooms
* beds
* bed_type
* price
* security_deposit
* cleaning_fee
* guests_included 
* extra_people_cost
* minimum_nights
* maximum_nights
* availability_30
* number_of_reviews
* review_scores_rating
* review_scores_accuracy
* review_scores_cleanliness
* review_scores_checkin
* review_scores_communication
* review_scores_location
* review_scores_value
* reviews_per_month
* cancellation_policy

# Background

Airbnb, inc. is a privately held global company headquartered in San Francisco that operates as a broker for lodging arrangements. Made famous by celebrities like Kim Kardashian, the company is revolutionizing the way people vacation. Rather than booking a hotel, users can go on the AirBnB website or mobile app and quickly rent private rooms, guest suites or even entire homes to themselves. The company has often faced controversy surrounding housing affordability, pricing transparency, privacy and hotel industry competition. Despite these concerns, it blew by its own internal forecasts and brought in 2.6 billion dollars in revenue and 93 million in profit by the end of 2017. For a company that exclusively makes money by taking a small commission (3%) of the price of every listing, that’s pretty impressive.
  
  We were interested in this data because it’s something that so many people, especially our peers here at Duke, would find relevant. There are over 4 million AirBnB listings worldwide and 150 million global users. Both Mary Helen and I have stayed in an AirBnB in the last month. With the option to rent entire homes, AirBnBs offer more luxury, space and solitude than other lodging options. Hosts set prices for listings at their own discretion, and so there isn’t any specific algorithm or model by which it’s calculated. By using this data to create a model that can accurately predict prices for listings, we might be able to help people figure out what the typical price range is for the type of listing they want – and therefore, whether or not a specific listing is a good deal. Specifically, we’ll be looking at AirBnB listings in the Asheville Metro Area, North Carolina. Asheville is a popular weekend getaway in North Carolina. Given its relative proximity to Duke, many students visit at least once during their time here – often staying in AirBnBs when they do. This makes our data more relevant to our peers, and also helps us by narrowing down the total number of observations into a size that’s more manageable.

# Exploratory Data Analysis
```{r pairs-plots with log transformations}
#Pairs plots for all of the explanatory variables
pairs(logprice ~ cancellation_policy + host_is_superhost + host_listings_count, data=train.airbnb)
pairs(logprice ~ zipcode + beds + bathrooms, data=train.airbnb)
pairs(logprice ~ accommodates + room_type + bed_type, data=train.airbnb)
pairs(logprice ~ security_deposit + cleaning_fee + guests_included, data = train.airbnb)
pairs(logprice ~ extra_people + log(minimum_nights) + availability_30, data = train.airbnb)
pairs(logprice ~ log(number_of_reviews +1) + log(review_scores_rating +1) + review_scores_accuracy, data = train.airbnb)
pairs(logprice ~ log(review_scores_cleanliness +1) + review_scores_checkin + review_scores_communication, data = train.airbnb)
pairs(logprice ~ log(review_scores_location +1) + review_scores_value + log(reviews_per_month +1), data = train.airbnb)
pairs(logprice ~ inzip28801 + inzip28804, data = train.airbnb)
```


```{r price-boxplot, warning=FALSE}
#Distribution of nightly price
ggplot(train.airbnb, aes(x=logprice)) + geom_histogram() + labs(title="Distribution of Log nightly prices")
ggplot(train.airbnb, aes(x=price)) + geom_histogram(stat="count") + labs(title="Distribution of nightly prices")

#Boxplot of price by bed type
ggplot(train.airbnb, aes(x=bed_type, y=logprice)) + geom_boxplot() + labs(title="Distribution of log nightly price by bed type")

#Boxplot of price by room type
ggplot(train.airbnb, aes(x=room_type, y=logprice)) + geom_boxplot() + labs(title="Distribution of log nightly price by room type")

#Distribution of Cleaning Fees
ggplot(train.airbnb, aes(x=cleaning_fee)) + geom_histogram() + labs(title="Distribution of cleaning fees")


#Boxplot of LogPrice by Zipcode
ggplot(train.airbnb, aes(x=zipcode, y=logprice)) + geom_boxplot() + labs(title="Distribution of log nightly price by zipcode")

ggplot(train.airbnb, aes(x=logprice)) + geom_histogram()


#Boxplot of log price by bed type
ggplot(train.airbnb, aes(x=bed_type, y=logprice)) + geom_boxplot()
```

# Model building

*NOTE* -> we are omitting host_response_rate from our model because we were having trouble converting the variable to a numeric without losing a lot of the information. Will address before final due date. 

```{r first-model, message=FALSE}
full.model <- lm(logprice ~ host_is_superhost
+ host_listings_count
+ room_type
+ accommodates
+ bathrooms
+ beds
+ bed_type
+ cleaning_fee
+ extra_people
+ minimum_nights
+ availability_30
+ log.number_of_reviews
+ log.review_scores_rating
+ log.review_scores_accuracy
+ log.review_scores_cleanliness
+ log.review_scores_checkin
+ log.review_scores_communication
+ log.review_scores_location
+ log.review_scores_value
+ log.reviews_per_month
+ cancellation_policy, data=train.airbnb)

kable(tidy(full.model), format="markdown", digits = 4)
kable(glance(full.model))
```

```{r backwards-selection, full log model}
backward.log.model <- ols_step_backward_aic(full.model)
```

```{r final-backwards main-model}
backwards.full.model <- lm(logprice ~ host_is_superhost
+ zipcode
+ room_type
+ accommodates
+ bathrooms
+ cleaning_fee
+ extra_people
+ minimum_nights
+ availability_30
+ log.review_scores_cleanliness
+ log.review_scores_checkin
+ log.reviews_per_month
+ cancellation_policy, data=train.airbnb)

kable(tidy(backwards.full.model), format="markdown", digits = 4)
kable(glance(backwards.full.model))
```

```{r interactions}
#model with interaction effects
interactions.model <- lm(logprice ~ cleaning_fee * bathrooms + cleaning_fee * accommodates + room_type * bathrooms + accommodates * bathrooms + cleaning_fee * log.review_scores_cleanliness + availability_30 * minimum_nights + cancellation_policy * accommodates + host_is_superhost
+ host_listings_count
+ room_type
+ accommodates
+ bathrooms
+ beds
+ bed_type
+ cleaning_fee
+ extra_people
+ minimum_nights
+ availability_30
+ log.number_of_reviews
+ log.review_scores_rating
+ log.review_scores_accuracy
+ log.review_scores_cleanliness
+ log.review_scores_checkin
+ log.review_scores_communication
+ log.review_scores_location
+ log.review_scores_value
+ log.reviews_per_month
+ cancellation_policy, data=train.airbnb)

#anova test
kable(anova(full.model, interactions.model)) # there is a significant interaction term
```

```{r backwards-interactions, warning=FALSE}
stepwise.interactions.model <- ols_step_both_aic(interactions.model, details=FALSE)
```

```{r final-interactions-model}
stepwise.interactions.model <- lm(logprice ~ cleaning_fee * accommodates + availability_30 * minimum_nights
+ host_is_superhost
+ room_type
+ accommodates
+ cleaning_fee
+ minimum_nights
+ availability_30
+ log.reviews_per_month
+ cancellation_policy, data=train.airbnb)

kable(tidy(stepwise.interactions.model), format="markdown", digits = 4)
kable(glance(stepwise.interactions.model))
```

```{r, examine zip code, warning=FALSE}
table2 <- airbnb %>% group_by(zipcode) %>% summarise(n=n())
kable(table2)

#zip code has high p values for areas with large observation counts and small alike. Only two zip codes are significant - make indicator variable to reduce noise. 
# also: extra people is high so I vote we self select it out
```

#Self Model
```{r full model no zip}
full.model <- lm(logprice ~ host_is_superhost
+ host_listings_count
+ room_type
+ accommodates
+ bathrooms
+ beds
+ bed_type
+ cleaning_fee
+ extra_people
+ minimum_nights
+ availability_30
+ log.number_of_reviews
+ log.review_scores_rating
+ log.review_scores_accuracy
+ log.review_scores_cleanliness
+ log.review_scores_checkin
+ log.review_scores_communication
+ log.review_scores_location
+ log.review_scores_value
+ log.reviews_per_month
+ cancellation_policy, data=train.airbnb)

kable(tidy(full.model), format="markdown", digits = 4)
kable(glance(full.model))
```

```{r, backwards with zip changes}
#ncol(train.airbnb$zip28801)
#ncol(train.airbnb$zipcode)
backwards.log.model <- ols_step_backward_aic(full.model)

step.log.model <- ols_step_both_aic(full.model)
```

# Assumptions
#exploratory
```{r}
pairs(logprice ~ accommodates + bathrooms, data = train.airbnb)
```




```{r resids 2}
train.airbnb <- train.airbnb %>% mutate(stand.resid = rstandard(stepwise.interactions.model),
                                        pred = predict(stepwise.interactions.model))

```

```{r standard residual-plots/qq}
ggplot(data = train.airbnb, aes(x=stand.resid)) + geom_histogram()
qqnorm(train.airbnb$stand.resid)
```

```{r - residuals plot against explanatory}
p1 <- ggplot(data = train.airbnb, aes(x=pred, y=stand.resid)) + geom_point() + 
  labs(x="Predicted", y="Residual", title="Residuals vs Predicted",
subtitle=("backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))


p2 <- ggplot(data = train.airbnb, aes(x=accommodates, y=stand.resid)) + geom_point() + 
  labs(x="Number of Guests", y="Residual", title="Residuals vs Accommodates",
subtitle=("backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))

p3 <- ggplot(data = train.airbnb, aes(x= cleaning_fee, y=stand.resid)) + geom_point() + 
  labs(x="Fee ($)", y="Residual", title="Residuals vs Cleaning Fee",
subtitle=("Backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))

p4 <-ggplot(data = train.airbnb, aes(x=minimum_nights, y=stand.resid)) + geom_point() + 
  labs(x="Minimum Nights", y="Residual", title="Residuals vs Minimum_nights",
subtitle=("Backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))

p5 <- ggplot(data = train.airbnb, aes(x=availability_30, y=stand.resid)) + geom_point() + 
  labs(x="Number of Available Nights in the next month", y="Residual", title="Residuals vs Availability",
subtitle=("backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))

p6 <- ggplot(data = train.airbnb, aes(x=log.reviews_per_month, y=stand.resid)) + geom_point() + 
  labs(x="Reviews per month", y="Residual", title="Residuals vs Log Reviews per month",
subtitle=("backwards.interactions.model"))+
theme(plot.title = element_text(hjust = 0.5,size=14),
plot.subtitle=element_text(hjust=0.5,size=10))
```


```{r}
plot_grid(p1,p2,p3,p4)
plot_grid(p5,p6)
```


plots - log cleaning fee

2. Constant variance 

3. Normality

4. Independence 


5. Leverage Points/ outliers

```{r outliers}
train.airbnb <- train.airbnb %>%
  mutate(leverage = hatvalues(stepwise.interactions.model), 
         cooks = cooks.distance(stepwise.interactions.model),
         obs.num = row_number())

ggplot(data=train.airbnb, aes(x=obs.num,y=leverage)) + 
  geom_point(alpha=0.5) + 
  geom_hline(yintercept=36/1520,color="red")+
  labs(x="Observation Number",y="Leverage",title="Leverage")

ggplot(data=train.airbnb, aes(x=obs.num,y=cooks)) + 
  geom_point() + 
  geom_hline(yintercept=1,color="red")+
  labs(x="Observation Number",y="Cook's Distance",title="Cook's Distance")

tidy(vif(stepwise.interactions.model))
```

# Prediction 

#```{r predict-testing, warning=FALSE}
#Predict on the testing set using our final model
test.airbnb <- test.airbnb %>% mutate(predict = predict.lm(stepwise.interactions.model, test.airbnb))

test.airbnb <- test.airbnb %>% mutate(test.resid2 = test.airbnb$logprice - test.airbnb$predict)

ggplot(test.airbnb, aes(x=predict, y=test.resid2)) + geom_point() + 
  labs(title = "Residuals vs Predicted", subtitle = "Test Data Set", x = "predicted", y = "residual") +
  geom_hline(yintercept=0,color="red") + 
  theme(plot.subtitle = element_text(hjust=0.5))


# residuals
ggplot(test.airbnb, aes(x=predict, y=logprice)) + geom_point() +labs(title = "Logprice vs Predicted")

mse.train <- summary(stepwise.interactions.model)$sigma^2
mse.test  <- sum((test.resid2)^2)/(nrow(test.airbnb)-2)

print(mse.train)
print(mse.test)
```

# Alternative Models
